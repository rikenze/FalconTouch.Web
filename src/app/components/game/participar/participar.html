<div class="participar-page">
  <div class="participacao-text">
    <h2>Confirmacao de Participacao</h2>
    <p class="sub">Voce esta prestes a garantir sua chance no <strong>FalconTouch</strong>.</p>
  </div>

  <div class="product-container">
    <img
      *ngIf="product.imagens.length > 0 && product.imagens[0]"
      [src]="product.imagens[0].imagem"
      alt="{{ product.name }}"
      class="premio-img"
    />
    <h3 class="product-name">{{ product.name }}</h3>
  </div>

  <div class="preco-section" *ngIf="preco">
    <p><strong>Valor:</strong> <span class="price"> {{ preco | number: '1.2-2' }} R$</span></p>
    <p class="info">Pagamento unico. Nenhuma cobranca adicional sera feita.</p>
  </div>

  <form [formGroup]="formDadosEntrega" (ngSubmit)="confirmarPagamento()" novalidate>
    <fieldset class="form-group">
      <legend>Endereco para entrega</legend>

      <label for="rua">Rua *</label>
      <input id="rua" type="text" formControlName="rua" placeholder="Rua" />
      <small class="error" *ngIf="formDadosEntrega.get('rua')?.invalid && formDadosEntrega.get('rua')?.touched">
        Rua obrigatoria.
      </small>

      <label for="numero">Numero *</label>
      <input id="numero" type="text" formControlName="numero" placeholder="Numero" />
      <small class="error" *ngIf="formDadosEntrega.get('numero')?.invalid && formDadosEntrega.get('numero')?.touched">
        Numero obrigatorio.
      </small>

      <label for="bairro">Bairro *</label>
      <input id="bairro" type="text" formControlName="bairro" placeholder="Bairro" />
      <small class="error" *ngIf="formDadosEntrega.get('bairro')?.invalid && formDadosEntrega.get('bairro')?.touched">
        Bairro obrigatorio.
      </small>

      <label for="cidade">Cidade *</label>
      <input id="cidade" type="text" formControlName="cidade" placeholder="Cidade" />
      <small class="error" *ngIf="formDadosEntrega.get('cidade')?.invalid && formDadosEntrega.get('cidade')?.touched">
        Cidade obrigatoria.
      </small>

      <label for="estado">Estado *</label>
      <input id="estado" type="text" formControlName="estado" placeholder="Estado" maxlength="2" />
      <small class="error" *ngIf="formDadosEntrega.get('estado')?.invalid && formDadosEntrega.get('estado')?.touched">
        Estado obrigatorio e deve ter 2 caracteres.
      </small>

      <label for="cep">CEP *</label>
      <input id="cep" type="text" formControlName="cep" placeholder="12345-678" />
      <small class="error" *ngIf="formDadosEntrega.get('cep')?.invalid && formDadosEntrega.get('cep')?.touched">
        Informe um CEP valido.
      </small>
    </fieldset>

    <fieldset class="form-group">
      <legend>Contato</legend>

      <label for="telefone">Telefone *</label>
      <input id="telefone" type="text" formControlName="telefone" placeholder="(99) 99999-9999" mask="(00) 00000-0000" />
      <small class="error" *ngIf="formDadosEntrega.get('telefone')?.invalid && formDadosEntrega.get('telefone')?.touched">
        Informe um telefone valido.
      </small>
    </fieldset>

    <fieldset class="form-group">
      <legend>Cupom</legend>

      <div style="display: flex; gap: 8px; align-items: center;">
        <input
          id="couponCode"
          type="text"
          formControlName="couponCode"
          placeholder="Ex: falcon10"
          style="flex: 1;"
        />
        <button type="button" (click)="validarCupom(formDadosEntrega.get('couponCode')?.value)" class="btn btn-validate">
          Validar
        </button>
      </div>

      <div *ngIf="discount_percent > 0" style="margin-top: 8px;">
        <small>
          Valor original:
          <span style="text-decoration: line-through; color: gray;">
            {{ preco / (1 - discount_percent / 100) | number:'1.2-2' }} R$
          </span>
        </small>
        <br />
        <small>
          Novo valor com desconto ({{ discount_percent }}%):
          <strong style="color: green;">
            {{ preco | number:'1.2-2' }} R$
          </strong>
        </small>
      </div>
    </fieldset>

    <fieldset class="form-group">
      <legend>Forma de pagamento *</legend>

      <select id="formaPagamento" formControlName="formaPagamento">
        <option value="" disabled>Selecione</option>
        <option *ngFor="let metodo of metodosPagamento" [value]="metodo">{{ metodo }}</option>
      </select>
      <small class="error" *ngIf="formDadosEntrega.get('formaPagamento')?.invalid && formDadosEntrega.get('formaPagamento')?.touched">
        Escolha uma forma de pagamento.
      </small>
    </fieldset>

    <div *ngIf="loadingPagamento" class="loading-overlay">
      <div class="spinner"></div>
      <p>Carregando dados do pagamento...</p>
    </div>

    <div *ngIf="pixQrCode && isPixSelected" class="pix-container" style="margin-top: 20px; text-align:center;">
      <h4>Pagamento via Pix</h4>
      <img [src]="pixQrCode" alt="QR Code Pix" style="max-width: 250px; border: 1px solid #ccc; padding: 10px;" />
      <p><strong>Codigo Pix:</strong></p>
      <div style="position: relative;">
        <textarea readonly rows="3" style="width: 100%; font-family: monospace;">{{ pixCode }}</textarea>
        <button type="button" class="copy-button" (click)="copiarPixCode()">
          Copiar
        </button>
      </div>

      <small *ngIf="copiado" class="copied-msg">Codigo Pix copiado!</small>
    </div>

    <fieldset *ngIf="formDadosEntrega.get('formaPagamento')?.value === 'Cartao de Credito'">
      <legend>Dados do Cartao</legend>
      <div id="card-element" class="stripe-card-container"></div>
    </fieldset>

    <button class="btn btn-pay" type="submit">{{textBtnPay}}</button>
  </form>

  <p class="security-note">Pagamento 100% seguro.</p>

  <button class="btn btn-back" (click)="voltar()">Voltar</button>

  <app-notification
    [show]="showNotificationDialog"
    [message]="notificationMessage"
    [type]="notificationType"
    (dismiss)="showNotificationDialog = false">
  </app-notification>
</div>
